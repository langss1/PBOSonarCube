<!DOCTYPE html>
<html lang="id">

<head th:replace="~{fragments/pengurus_layout :: head(title='Dashboard Pengurus')}">
  <title>Dashboard Pengurus</title>
</head>

<body style="padding-top: 80px;">

  <style>
    /* Custom Styles for Dashboard moved here to allow head fragment replacement */
    /* Hero Section */
    .hero-wrapper {
      position: relative;
      width: 100%;
      height: 400px;
      border-radius: 20px;
      overflow: hidden;
      margin-top: 1rem;
      margin-bottom: 2rem;
    }

    .hero-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center;
    }

    .hero-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      padding: 2rem;
      background: linear-gradient(to top, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0) 100%);
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-end;
      height: 100%;
    }

    .hero-text {
      font-size: 1.1rem;
      color: #444;
      line-height: 1.6;
      max-width: 600px;
    }

    .highlight {
      color: #0b492c;
      font-weight: 700;
    }

    /* Section Header & Search */
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .section-title {
      font-weight: 700;
      color: #0b492c;
      font-size: 1.5rem;
      border-bottom: 3px solid #0b492c;
      padding-bottom: 0.5rem;
      margin: 0;
    }

    /* Table - Overrides some layout defaults */
    .table-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      border: 1px solid #eee;
    }

    .table thead th {
      background-color: transparent;
      border-bottom: 1px solid #eee;
      color: #777;
      font-weight: 700;
      font-size: 0.85rem;
      text-transform: uppercase;
      padding: 1rem;
    }

    .table tbody td {
      vertical-align: middle;
      padding: 1rem;
      font-size: 0.95rem;
      border-bottom: 1px solid #f9f9f9;
    }

    .table tbody tr:last-child td {
      border-bottom: none;
    }

    .user-name {
      font-weight: 600;
      color: #000;
    }

    .contact-info {
      color: #555;
    }

    .time-info {
      color: #666;
      font-size: 0.9rem;
    }

    .date-part {
      color: #888;
      font-size: 0.85rem;
      margin-right: 5px;
    }

    .facility-list {
      list-style: none;
      padding: 0;
      margin: 0;
      font-size: 0.9rem;
      color: #444;
    }

    /* View More Button */
    .btn-view-more {
      border: 1px solid #28a745;
      color: #28a745;
      background: white;
      border-radius: 50px;
      padding: 0.5rem 2rem;
      font-weight: 500;
      transition: all 0.3s;
      text-decoration: none;
    }

    .btn-view-more:hover {
      background: #28a745;
      color: white;
    }
  </style>

  <!-- NAVBAR -->
  <nav th:replace="~{fragments/pengurus_layout :: navbar(activePage='dashboard')}"></nav>

  <div class="container pb-5">
    <!-- HERO -->
    <div class="hero-wrapper">
      <img th:src="@{/assets/pengurus/Assets/gedung.png}" class="hero-image" alt="Gedung MSU">
      <div class="hero-overlay">
        <div class="hero-text">
          <p>
            Satu langkah menuju <span class="highlight">kemudahan beraktivitas</span> di MSU.<br>
            Semua urusan peminjaman dan perizinan kini bisa dilakukan secara online.
          </p>
        </div>
      </div>
    </div>

    <!-- CONTENT -->
    <div class="d-flex justify-content-between align-items-center mb-4 mt-4">
      <div>
        <h3 class="section-title">Peminjaman Hari Ini</h3>
      </div>
      <div class="col-md-4">
        <div class="input-group">
          <span class="input-group-text bg-white border-end-0 rounded-start-pill ps-3">
            <i class="bi bi-search text-muted"></i>
          </span>
          <input type="text" id="searchInput" class="form-control border-start-0 rounded-end-pill"
            placeholder="Cari...">
        </div>
      </div>
    </div>

    <!-- Empty State (No Table Headers) -->
    <div th:if="${#lists.isEmpty(activeLoans)}" class="table-container text-center py-5">
      <div class="d-flex flex-column align-items-center justify-content-center"
        style="color: #6c757d; min-height: 250px;">
        <i class="bi bi-calendar-event" style="font-size: 3rem; margin-bottom: 1rem; color: #8fbc8f;"></i>
        <h5 class="fw-normal text-dark mb-2">Data peminjaman hari ini akan muncul di sini.</h5>
        <p class="small text-muted mb-4">Silakan cek menu Peminjaman Ruangan untuk detail lengkap.</p>
        <a th:href="@{/pengurus/fasilitas}" class="btn btn-success rounded-pill px-4 fw-medium"
          style="background-color: #198754; border: none;">
          Lihat Semua Peminjaman
        </a>
      </div>
    </div>

    <div class="table-container" th:if="${!#lists.isEmpty(activeLoans)}">
      <table class="table table-borderless">
        <thead>
          <tr>
            <th class="text-center" style="width: 5%;">NO</th>
            <th style="width: 15%;">NAMA PEMINJAM</th>
            <th style="width: 12%;">KONTAK</th>
            <th style="width: 14%;">WAKTU AMBIL</th>
            <th style="width: 14%;">WAKTU KEMBALI</th>
            <th style="width: 20%;">FASILITAS</th>
            <th class="text-center" style="width: 10%;">SUDAH AMBIL</th>
            <th class="text-center" style="width: 10%;">SUDAH KEMBALI</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <!-- Data Rows -->
          <tr th:each="p, iterStat : ${activeLoans}">
            <td class="text-center text-muted" th:text="${iterStat.count}">1</td>
            <td class="user-name" th:text="${p.borrowerName}">Muhammad Soleh</td>
            <td class="contact-info" th:text="${p.phone}">08123456789</td>

            <!-- Waktu Ambil -->
            <td>
              <div class="time-info">
                <span class="date-part" th:text="${#temporals.format(p.startDate, 'dd MMM yyyy')}"
                  style="color: #666;"></span>
                <span class="text-dark fw-bold">|</span>
                <span class="text-primary fw-semibold" th:text="${#temporals.format(p.startTime, 'HH:mm')}"></span>
              </div>
            </td>

            <!-- Waktu Kembali -->
            <td>
              <div class="time-info">
                <span class="date-part" th:text="${#temporals.format(p.endDate, 'dd MMM yyyy')}"
                  style="color: #666;"></span>
                <span class="text-dark fw-bold">|</span>
                <span class="text-primary fw-semibold" th:text="${#temporals.format(p.endTime, 'HH:mm')}"></span>
              </div>
            </td>

            <td>
              <ul class="facility-list">
                <li th:each="d : ${p.details}">
                  <span th:text="${d.item.name}"></span>
                  <span class="text-muted" th:text="'(x' + ${d.quantity} + ')'"></span>
                </li>
              </ul>
            </td>

            <!-- Functional Checkboxes -->
            <td class="text-center">
              <div class="form-check d-flex justify-content-center">
                <input class="form-check-input checkbox-taken" type="checkbox"
                  th:checked="${p.status.name() == 'TAKEN'}" th:disabled="${p.status.name() == 'TAKEN'}"
                  th:data-id="${p.id}" style="cursor: pointer; width: 1.2rem; height: 1.2rem;" />
              </div>
            </td>
            <td class="text-center">
              <div class="form-check d-flex justify-content-center">
                <input class="form-check-input checkbox-returned" type="checkbox" th:data-id="${p.id}"
                  style="cursor: pointer; width: 1.2rem; height: 1.2rem;" />
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Footer Action -->
    <div class="d-flex justify-content-center mt-4" th:if="${!#lists.isEmpty(activeLoans)}">
      <a th:href="@{/pengurus/fasilitas}" class="btn-view-more">
        Lihat Selengkapnya <i class="bi bi-arrow-right ms-1"></i>
      </a>
    </div>

  </div>

  <!-- HIDDEN FORM FOR ACTIONS -->
  <form id="statusForm" method="post" th:action="@{/pengurus/fasilitas/update-status}" style="display: none;">
    <input type="hidden" name="id" id="formId">
    <input type="hidden" name="action" id="formAction">
    <input type="hidden" name="redirect" value="/pengurus/dashboard">
  </form>

  <!-- TOAST NOTIFICATION CONTAINER -->
  <!-- TOAST NOTIFICATION CONTAINER -->
  <div th:replace="~{fragments/pengurus_layout :: toast_container}"></div>

  <div th:replace="~{fragments/pengurus_layout :: scripts}"></div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {

      // Toast Function
      function showToast(message) {
        const toastEl = document.getElementById('liveToast');
        const toastMsg = document.getElementById('toastMessage');
        const progressBar = document.getElementById('toastProgressBar');

        toastMsg.textContent = message;

        const toast = new bootstrap.Toast(toastEl, { delay: 3000, autohide: true });

        toastEl.addEventListener('shown.bs.toast', function () {
          progressBar.style.width = '0%';
        });

        toastEl.addEventListener('hidden.bs.toast', function () {
          progressBar.style.width = '100%';
        });

        // Initial state
        progressBar.style.width = '100%';
        toast.show();
      }

      // SEARCH SEARCH SEARCH
      const searchInput = document.getElementById('searchInput');
      if (searchInput) {
        searchInput.addEventListener('keyup', function () {
          const searchTerm = this.value.toLowerCase();
          const rows = document.querySelectorAll('#tableBody tr');

          rows.forEach(row => {
            // Skip empty state row if it exists
            if (row.cells.length === 1) return;

            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchTerm) ? '' : 'none';
          });
        });
      }

      // Handle "Sudah Ambil" Checkbox
      const takenCheckboxes = document.querySelectorAll('.checkbox-taken');
      takenCheckboxes.forEach(cb => {
        cb.addEventListener('change', function (e) {
          e.preventDefault();
          const id = this.getAttribute('data-id');
          const checkbox = this;

          if (this.checked) {
            Swal.fire({
              title: 'Konfirmasi Pengambilan',
              text: "Ruangan berhasil diambil. Jangan lupa mintakan kartu identitas sebagai bukti peminjaman",
              icon: 'question',
              showCancelButton: true,
              confirmButtonColor: '#198754',
              cancelButtonColor: '#6c757d',
              confirmButtonText: 'Ya, Sudah ambil',
              cancelButtonText: 'Tidak'
            }).then((result) => {
              if (result.isConfirmed) {
                updateStatusAjax(id, 'TAKEN', checkbox);
              } else {
                checkbox.checked = false; // Revert check
              }
            });
          }
        });
      });

      // Handle "Sudah Kembali" Checkbox
      const returnedCheckboxes = document.querySelectorAll('.checkbox-returned');
      returnedCheckboxes.forEach(cb => {
        cb.addEventListener('change', function (e) {
          e.preventDefault();
          const id = this.getAttribute('data-id');
          const checkbox = this;

          // Find corresponding "Sudah Ambil" checkbox in the same row
          const row = this.closest('tr');
          const takenCheckbox = row.querySelector('.checkbox-taken');

          if (this.checked) {
            Swal.fire({
              title: 'Konfirmasi Pengembalian',
              text: "Ruangan berhasil dikembalikan. Jangan lupa kembalikan kartu identitas sebagai bukti pengembalian",
              icon: 'question',
              showCancelButton: true,
              confirmButtonColor: '#198754',
              cancelButtonColor: '#6c757d',
              confirmButtonText: 'Ya, Sudah kembali',
              cancelButtonText: 'Tidak'
            }).then((result) => {
              if (result.isConfirmed) {
                // Determine if we need to auto-check taken
                if (takenCheckbox && !takenCheckbox.checked) {
                  // If we are marking returned, it implies taken.
                }
                updateStatusAjax(id, 'RETURNED', checkbox, takenCheckbox);
              } else {
                checkbox.checked = false;
              }
            });
          }
        });
      });

      function updateStatusAjax(id, action, checkbox, linkedCheckbox = null) {
        // Prepare Form Data
        const formData = new FormData();
        formData.append('id', id);
        formData.append('action', action);

        fetch('/pengurus/api/fasilitas/update-status', {
          method: 'POST',
          body: formData
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              showToast(data.message || 'Status berhasil diperbarui');

              // Visual Updates
              checkbox.checked = true;
              checkbox.disabled = true;

              if (linkedCheckbox) {
                linkedCheckbox.checked = true;
                linkedCheckbox.disabled = true;
              }

            } else {
              Swal.fire('Error', data.message || 'Gagal memperbarui status', 'error');
              checkbox.checked = false;
            }
          })
          .catch(error => {
            console.error('Error:', error);
            Swal.fire('Error', 'Terjadi kesalahan koneksi', 'error');
            checkbox.checked = false;
          });
      }
    });
  </script>
</body>

</html>