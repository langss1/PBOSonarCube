<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pengelola MSU â€” Laporan</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

  <style>
    body {
      background: #ffffff;
      font-family: "Poppins", sans-serif;
    }

    .shadow-soft {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08),
        0 2px 4px rgba(0, 0, 0, 0.04);
    }

    .shadow-strong {
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12),
        0 4px 6px rgba(0, 0, 0, 0.08);
    }

    .navbar-nav .nav-link {
      color: #2fa16c;
      font-weight: 600;
      margin: 0 10px;
      transition: color 0.2s;
    }

    .navbar-nav .nav-link:hover {
      color: #0b492c;
    }

    .navbar-nav .nav-link.active {
      color: #0b492c !important;
    }

    .toolbar .btn,
    .toolbar .form-select,
    .toolbar .form-control,
    .toolbar .input-group-text {
      border-radius: 9999px;
    }

    .toolbar .btn-pill {
      border-radius: 9999px;
      border: 1px solid #0b492c;
      color: #0b492c;
      background: #fff;
    }

    .toolbar .btn-pill:hover,
    .toolbar .btn-pill:focus {
      color: #0b492c;
      background: #f5fbf7;
      border-color: #0b492c;
    }

    .toolbar .dropdown-menu {
      border-radius: 14px;
      border: 1px solid #0b492c;
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.1);
      padding: 6px 0;
      min-width: 100%;
    }

    .toolbar .dropdown-item {
      padding: 0.5rem 1rem;
      border-radius: 10px;
    }

    .toolbar .dropdown-item.active,
    .toolbar .dropdown-item:hover {
      background: #e9f6ef;
      color: #0b492c;
    }

    .table-wrapper {
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
      padding: 16px;
    }

    .table thead th {
      color: #5f6b77;
      font-weight: 700;
      font-size: 0.9rem;
      white-space: nowrap;
      vertical-align: middle;
      background: #f7f8fa;
      border-bottom: 2px solid #b7c1cc !important;
    }

    .table-bordered {
      border: 1.5px solid #b7c1cc !important;
    }

    .table-bordered> :not(caption)>* {
      border-width: 1.5px 0;
    }

    .table-bordered> :not(caption)>*>* {
      border-color: #b7c1cc !important;
      padding: 0.8rem 0.75rem;
      vertical-align: middle;
      font-size: 0.95rem;
    }

    .badge-status {
      display: inline-block;
      min-width: 130px;
      text-align: center;
      border-radius: 9999px;
      padding: 0.35rem 0.6rem;
      font-weight: 600;
      font-size: 0.8rem;
      white-space: nowrap;
    }

    .status-sedang {
      background: #f3f7cf;
      color: #6a7b00;
    }

    .status-sudah {
      background: #d9f3e7;
      color: #0b492c;
    }

    .status-terlambat {
      background: #7a2c2c;
      color: #fff;
    }

    .status-menunggu {
      background: #fff3cd;
      color: #856404;
    }

    .status-siap {
      background: #cff4fc;
      color: #055160;
    }

    .status-batal {
      background: #f8d7da;
      color: #842029;
    }

    #fSearch:focus {
      border-color: #000;
      box-shadow: none;
      outline: none;
    }

    @media print {

      .shadow-soft,
      .shadow-strong,
      .table-wrapper {
        box-shadow: none !important;
      }

      .table thead th {
        background: #eee !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }

      .table-bordered {
        border: 2px solid #000 !important;
      }

      .table-bordered> :not(caption)>*>* {
        border-color: #000 !important;
      }

      .navbar {
        display: none;
      }
    }
  </style>
</head>

<body>
  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg fixed-top shadow-soft bg-white">
    <div class="container">
      <a class="navbar-brand" th:href="@{/pengelola/beranda}">
        <img th:src="@{/assets/pengelola/aset/logo.png}" alt="Logo MSU" style="height: 45px" />
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navmenu">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse justify-content-end" id="navmenu">
        <ul class="navbar-nav mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link" th:href="@{/pengelola/beranda}">Beranda</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" aria-current="page" th:href="@{/pengelola/laporan}">Laporan</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" th:href="@{/pengelola/tambah}">Tambah Barang</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" th:href="@{/pengelola/approval}">Approval</a>
          </li>
        </ul>

        <!-- USER DROPDOWN + LOGOUT (SAMA DENGAN BERANDA) -->
        <div class="ms-3 dropdown">
          <button class="btn btn-outline-secondary d-flex align-items-center rounded-pill px-3 py-1 border-0"
            type="button" id="userMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
            <img id="userAvatar" th:src="@{/assets/pengelola/aset/MSU.png}" alt="User" class="rounded-circle me-2"
              width="32" height="32" />
            <div class="text-start">
              <div id="userName" class="fw-semibold text-dark small">
                Pengelola
              </div>
              <div id="userRoleLabel" class="text-muted" style="font-size: 0.75rem">
                Pengelola Side
              </div>
            </div>
            <i class="bi bi-chevron-down ms-2 small"></i>
          </button>

          <ul class="dropdown-menu dropdown-menu-end mt-2">
            <li>
              <button class="dropdown-item text-danger" id="btnLogout" type="button">
                <i class="bi bi-box-arrow-right me-2"></i>Keluar
              </button>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </nav>

  <div style="height: 84px"></div>

  <div class="container">
    <!-- Toolbar -->
    <div class="toolbar d-flex flex-wrap gap-3 align-items-center mb-4">
      <!-- Unduh split button -->
      <div class="btn-group">
        <button type="button" class="btn btn-outline-success px-4" style="border-color: #0b492c; color: #0b492c">
          <i class="bi bi-download me-2"></i>Unduh
        </button>
        <button type="button" class="btn btn-outline-success dropdown-toggle dropdown-toggle-split"
          data-bs-toggle="dropdown" aria-expanded="false" style="border-color: #0b492c; color: #0b492c">
          <span class="visually-hidden">Toggle Dropdown</span>
        </button>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" th:href="@{/pengelola/laporan/download/xlsx}">.XLSX</a></li>
          <li><a class="dropdown-item" th:href="@{/pengelola/laporan/download/csv}">.CSV</a></li>
          <li><a class="dropdown-item" th:href="@{/pengelola/laporan/download/pdf}">.PDF</a></li>
        </ul>
      </div>

      <!-- PERIODE (DROPDOWN DATE PICKER) -->
      <div class="dropdown">
        <button class="btn btn-pill dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false"
          id="btnPilihTanggal">
          Pilih Tanggal
        </button>
        <div class="dropdown-menu p-3 shadow-strong border-0" style="min-width: 280px; border-radius: 12px;">
          <h6 class="fw-bold fs-6 mb-3" style="color: #0b492c;">Custom Range</h6>

          <div class="row g-2 mb-3">
            <div class="col-6">
              <label for="dateStart" class="form-label small text-muted mb-1">Dari</label>
              <div class="input-group input-group-sm">
                <input type="date" id="dateStart" class="form-control rounded-pill border-secondary"
                  style="font-size: 0.85rem;">
              </div>
            </div>
            <div class="col-6">
              <label for="dateEnd" class="form-label small text-muted mb-1">Sampai</label>
              <div class="input-group input-group-sm">
                <input type="date" id="dateEnd" class="form-control rounded-pill border-secondary"
                  style="font-size: 0.85rem;">
              </div>
            </div>
          </div>

          <button type="button" id="btnApplyDate" class="btn btn-success w-100 rounded-pill btn-sm fw-semibold"
            style="background-color: #0b492c; border-color: #0b492c;">
            Terapkan
          </button>
        </div>
      </div>

      <!-- KATEGORI -->
      <div class="dropdown">
        <button class="btn btn-pill dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false"
          id="btnKategori">
          Semua Kategori
        </button>
        <ul class="dropdown-menu" aria-labelledby="btnKategori">
          <li>
            <a class="dropdown-item active" href="#" data-value="all">Semua Kategori</a>
          </li>
          <li>
            <a class="dropdown-item" href="#" data-value="Barang">Barang</a>
          </li>
          <li>
            <a class="dropdown-item" href="#" data-value="Ruangan">Ruangan</a>
          </li>
        </ul>
      </div>

      <!-- STATUS -->
      <div class="dropdown">
        <button class="btn btn-pill dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false"
          id="btnStatus">
          Semua Status
        </button>
        <ul class="dropdown-menu" aria-labelledby="btnStatus">
          <li>
            <a class="dropdown-item active" href="#" data-value="all">Semua Status</a>
          </li>
          <li>
            <a class="dropdown-item" href="#" data-value="Sedang Dipinjam">Sedang Dipinjam</a>
          </li>
          <li>
            <a class="dropdown-item" href="#" data-value="Sudah Kembali">Sudah Kembali</a>
          </li>
          <li>
            <a class="dropdown-item" href="#" data-value="Selesai">Selesai</a>
          </li>
          <li>
            <a class="dropdown-item" href="#" data-value="Terlambat">Terlambat</a>
          </li>
          <li>
            <a class="dropdown-item" href="#" data-value="Siap Diambil">Siap Diambil</a>
          </li>
        </ul>
      </div>

      <div class="ms-auto"></div>

      <!-- Search -->
      <div class="input-group" style="max-width: 320px">
        <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
        <input id="fSearch" type="text" class="form-control" placeholder="Cari laporan..." />
      </div>
    </div>

    <!-- TABLE -->
    <div class="table-wrapper mb-4">
      <div class="table-responsive">
        <table class="table table-bordered align-middle text-nowrap">
          <thead>
            <tr>
              <th style="width: 48px">No</th>
              <th>Nama</th>
              <th>Kategori</th>
              <th>Peminjam</th>
              <th>Waktu Pinjam</th>
              <th>Jatuh Tempo</th>
              <th>Waktu Kembali</th>
              <th class="text-center">Jumlah</th>
              <th class="text-center">Status</th>
              <th>Keterangan</th>
            </tr>
          </thead>
          <tbody id="tbodyLaporan">
            <tr th:each="p, stat : ${listPeminjaman}" th:attr="data-kategori=${not #lists.isEmpty(p.details) ? #strings.capitalize(#strings.toLowerCase(p.details[0].item.type)) : ''},
                         data-status=${p.status.name() == 'PENDING' ? 'Menunggu' : 
                                       (p.status.name() == 'APPROVED' ? 'Siap Diambil' : 
                                       (p.status.name() == 'TAKEN' ? 'Sedang Dipinjam' : 
                                       (p.status.name() == 'RETURNED' ? 'Sudah Kembali' : 
                                       (p.status.name() == 'COMPLETED' ? 'Selesai' : 
                                       (p.status.name() == 'OVERDUE' ? 'Terlambat' : 
                                       (p.status.name() == 'REJECTED' ? 'Ditolak' : ''))))))}">
              <td th:text="${stat.count}">1</td>
              <td>
                <span th:if="${not #lists.isEmpty(p.details)}" th:text="${p.details[0].item.name}">Item Name</span>
                <span th:if="${#lists.size(p.details) > 1}" class="badge bg-secondary rounded-pill"
                  th:text="'+' + (${#lists.size(p.details)} - 1)"></span>
                <span th:if="${#lists.isEmpty(p.details)}" class="text-muted">-</span>
              </td>
              <td>
                <span th:if="${not #lists.isEmpty(p.details)}" th:text="${p.details[0].item.type}">Type</span>
                <span th:if="${#lists.isEmpty(p.details)}">-</span>
              </td>
              <td th:text="${p.borrowerName}">Peminjam</td>
              <td>
                <span
                  th:text="${#temporals.format(p.startDate, 'dd/MM/yyyy')} + ' | ' + ${#temporals.format(p.startTime, 'HH:mm')}">Start</span>
              </td>
              <td>
                <span
                  th:text="${#temporals.format(p.endDate, 'dd/MM/yyyy')} + ' | ' + ${#temporals.format(p.endTime, 'HH:mm')}">End</span>
              </td>
              <td>
                <span th:if="${p.returned}"
                  th:text="${p.laporan != null and p.laporan.returnedAt != null ? #temporals.format(p.laporan.returnedAt, 'dd/MM/yyyy | HH:mm') : '-'}">-</span>
                <span th:unless="${p.returned}">-</span>
              </td>
              <td class="text-center">
                <span th:if="${not #lists.isEmpty(p.details)}" th:text="${p.details[0].quantity}">1</span>
              </td>
              <td class="text-center">
                <span th:if="${p.status != null and p.status.name() == 'PENDING'}"
                  class="badge badge-status status-menunggu">Menunggu</span>
                <span th:if="${p.status != null and p.status.name() == 'APPROVED'}"
                  class="badge badge-status status-siap">Siap Diambil</span>
                <span th:if="${p.status != null and p.status.name() == 'TAKEN'}"
                  class="badge badge-status status-sedang">Sedang Dipinjam</span>
                <span th:if="${p.status != null and p.status.name() == 'RETURNED'}"
                  class="badge badge-status status-sudah">Sudah Kembali</span>
                <span th:if="${p.status != null and p.status.name() == 'COMPLETED'}"
                  class="badge badge-status bg-primary text-white">Selesai</span>
                <span th:if="${p.status != null and p.status.name() == 'REJECTED'}"
                  class="badge badge-status status-batal">Ditolak</span>
                <span th:if="${p.status != null and p.status.name() == 'OVERDUE'}"
                  class="badge badge-status status-terlambat">Terlambat</span>
              </td>
              <td>
                <span
                  th:text="${p.laporan != null and p.laporan.notes != null and !p.laporan.notes.isEmpty() ? p.laporan.notes : '-'}">-</span>
              </td>
            </tr>
            <tr th:if="${#lists.isEmpty(listPeminjaman)}">
              <td colspan="9" class="text-center py-5 text-muted">Belum ada data laporan.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ANALISIS TREN (placeholder) -->
    <div class="card shadow-strong p-3 mb-5">
      <h6 class="mb-3">
        Top 10 yang paling sering dipinjam (hasil filter manual
        nanti)
      </h6>
      <canvas id="chartTop"></canvas>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script th:inline="javascript">
    /*<![CDATA[*/
    window.serverData = [];
    /*[# th:each="p : ${listPeminjaman}"]*/
    // Check if details exist
    /*[# th:if="${not #lists.isEmpty(p.details)}"]*/
    window.serverData.push({
      name: /*[[${p.details[0].item.name}]]*/ "Item",
      qty: /*[[${p.details[0].quantity}]]*/ 1
    });
    /*[/]*/
    /*[/]*/
    /*]]>*/
  </script>
  <script th:src="@{/assets/pengelola/laporan.js}"></script>
</body>

</html>