<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Approval Pengajuan - Pengelola MSU</title>

	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />

	<style>
		body {
			background-color: #ffffff;
			font-family: "Poppins", sans-serif;
		}

		.shadow-soft {
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08),
				0 2px 4px rgba(0, 0, 0, 0.04);
		}

		.navbar-nav .nav-link {
			color: #2fa16c;
			font-weight: 600;
			margin: 0 10px;
			transition: color 0.2s ease;
		}

		.navbar-nav .nav-link:hover {
			color: #0b492c;
		}

		.navbar-nav .nav-link.active {
			color: #0b492c !important;
		}

		input[type="search"]:focus,
		input[type="text"]:focus,
		.form-control:focus {
			box-shadow: none !important;
			border-color: #000 !important;
		}

		.action-buttons .btn {
			min-width: 90px;
		}
	</style>
</head>

<body class="pb-5">
	<nav class="navbar navbar-expand-lg fixed-top shadow-soft bg-white">
		<div class="container">
			<a class="navbar-brand" th:href="@{/pengelola/beranda}">
				<img th:src="@{/assets/pengelola/aset/logo.png}" alt="Logo MSU" style="height: 45px" />
			</a>
			<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navmenu">
				<span class="navbar-toggler-icon"></span>
			</button>
			<div class="collapse navbar-collapse justify-content-end" id="navmenu">
				<ul class="navbar-nav mb-2 mb-lg-0">
					<li class="nav-item">
						<a class="nav-link" th:href="@{/pengelola/beranda}">Beranda</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" th:href="@{/pengelola/laporan}">Laporan</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" th:href="@{/pengelola/tambah}">Tambah Barang</a>
					</li>
					<li class="nav-item">
						<a class="nav-link active" th:href="@{/pengelola/approval}">Approval</a>
					</li>
				</ul>

				<!-- USER DROPDOWN + LOGOUT SAMA SEPERTI BERANDA -->
				<div class="ms-3 dropdown">
					<button class="btn btn-outline-secondary d-flex align-items-center rounded-pill px-3 py-1 border-0"
						type="button" id="userMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
						<img id="userAvatar" th:src="@{/assets/pengelola/aset/MSU.png}" alt="User"
							class="rounded-circle me-2" width="32" height="32" />
						<div class="text-start">
							<div id="userName" class="fw-semibold text-dark small">
								Pengelola
							</div>
							<div id="userRoleLabel" class="text-muted" style="font-size: 0.75rem">
								Pengelola Side
							</div>
						</div>
						<i class="bi bi-chevron-down ms-2 small"></i>
					</button>

					<ul class="dropdown-menu dropdown-menu-end mt-2">
						<li>
							<a class="dropdown-item text-danger" id="btnLogout" th:href="@{/logout}">
								<i class="bi bi-box-arrow-right me-2"></i>Keluar
							</a>
						</li>
					</ul>
				</div>
				<!-- END USER DROPDOWN -->
			</div>
		</div>
	</nav>

	<div class="container" style="padding-top: 100px">
		<div class="row">
			<div class="col-12">
				<h2 class="mb-4">Daftar Pengajuan (Pending)</h2>
				<p class="text-muted mb-4">
					Tinjau pengajuan peminjaman barang dan fasilitas yang
					masih tertunda.
				</p>

				<table class="table table-hover align-middle mb-0">
					<thead class="table-light">
						<tr>
							<th scope="col">ID</th>
							<th scope="col">Peminjam</th>
							<th scope="col">Barang/Fasilitas</th>
							<th scope="col">Tgl Pinjam</th>
							<th scope="col">Status</th>
							<th scope="col" style="min-width: 190px">
								Aksi
							</th>
							<th scope="col" style="min-width: 150px">
								Proposal
							</th>
						</tr>
					</thead>
					<tbody id="submissionTableBody">
						<tr th:if="${#lists.isEmpty(pendingList)}">
							<td colspan="7" class="p-5 text-muted text-center">Tidak ada pengajuan pending saat ini.
							</td>
						</tr>
						<tr th:each="p : ${pendingList}">
							<td><strong th:text="${'P' + p.id}"></strong></td>
							<td th:text="${p.borrowerName}"></td>
							<td>
								<div th:each="d : ${p.details}">
									<span th:text="${d.item.name + ' (x' + d.quantity + ')'}"></span><br>
								</div>
							</td>
							<td th:text="${p.startDate}"></td>
							<td><span class="badge bg-warning text-dark" th:text="${p.status}"></span></td>
							<td>
								<div class="d-flex align-items-center" style="gap: 0.25rem;">
									<form th:action="@{/pengelola/approval/update}" method="post"
										style="display:inline;">
										<input type="hidden" name="id" th:value="${p.id}" />
										<input type="hidden" name="status" value="APPROVED" />
										<button type="submit" class="btn btn-success btn-sm btn-approve"
											onclick="return confirm('Setujui pengajuan ini?')">
											<i class="bi bi-check-lg"></i> Setuju
										</button>
									</form>
									<button type="button" class="btn btn-danger btn-sm btn-reject"
										th:attr="data-id=${p.id}"
										onclick="openRejectionModal(this.getAttribute('data-id'))">
										<i class="bi bi-x-lg"></i> Tolak
									</button>
								</div>
							</td>
							<td>
								<a th:if="${p.documentPath != null}" th:href="@{'/uploads/' + ${p.documentPath}}"
									target="_blank" class="btn btn-outline-primary btn-sm">
									<i class="bi bi-file-earmark-text"></i> Proposal
								</a>
								<span th:unless="${p.documentPath != null}">-</span>
							</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>
	</div>

	<div class="row mt-5 pt-3">
		<div class="col-12">
			<div class="d-flex justify-content-between align-items-center mb-4">
				<h2 class="mb-0">Riwayat Keputusan</h2>
				<!-- Export CSV is complex without JS, disabled for now or needs JS implementation re-enabled -->
				<button class="btn btn-success" id="btnExportCSV" disabled>
					<i class="bi bi-download me-2"></i>
					Ekspor Riwayat (CSV)
				</button>
			</div>

			<p class="text-muted mb-4">
				Daftar pengajuan yang telah disetujui atau ditolak.
			</p>

			<div class="table-responsive shadow-soft rounded-3">
				<table class="table table-hover align-middle mb-0">
					<thead class="table-light">
						<tr>
							<th scope="col">ID</th>
							<th scope="col">Peminjam</th>
							<th scope="col">Item</th>
							<th scope="col">Status</th>
						</tr>
					</thead>
					<tbody id="historyTableBody">
						<tr th:if="${#lists.isEmpty(historyList)}">
							<td colspan="4" class="p-5 text-muted text-center">Belum ada riwayat keputusan.</td>
						</tr>
						<tr th:each="h : ${historyList}">
							<td><strong th:text="${'P' + h.id}"></strong></td>
							<td th:text="${h.borrowerName}"></td>
							<td>
								<div th:each="d : ${h.details}">
									<span th:text="${d.item.name + ' (x' + d.quantity + ')'}"></span><br>
								</div>
							</td>
							<td>
								<span th:if="${h.status.name() == 'APPROVED'}" class="badge bg-success"
									th:text="${h.status}"></span>
								<span th:if="${h.status.name() == 'REJECTED'}" class="badge bg-danger"
									th:text="${h.status}"></span>
								<span th:if="${h.status.name() == 'COMPLETED'}" class="badge bg-primary"
									th:text="${h.status}"></span>
							</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>
	</div>
	</div>

	<div class="modal fade" id="rejectionModal" tabindex="-1" aria-labelledby="rejectionModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<form th:action="@{/pengelola/approval/update}" method="post">
					<div class="modal-header">
						<h5 class="modal-title" id="rejectionModalLabel">
							Alasan Penolakan
						</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<input type="hidden" name="id" id="rejectionSubmissionId" />
						<input type="hidden" name="status" value="REJECTED" />
						<div class="mb-3">
							<label for="rejectionReason" class="form-label">Catatan Alasan (Wajib diisi)</label>
							<textarea class="form-control" name="reason" id="rejectionReason" rows="4"
								required></textarea>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
							Batal
						</button>
						<button type="submit" class="btn btn-danger">
							Kirim Penolakan
						</button>
					</div>
				</form>
			</div>
		</div>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
	<script>
		function openRejectionModal(id) {
			document.getElementById('rejectionSubmissionId').value = id;
			var myModal = new bootstrap.Modal(document.getElementById('rejectionModal'));
			myModal.show();
		}
	</script>
</body>

</html>